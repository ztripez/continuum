# Entity Test World
# Tests entity member signals and aggregate operations

world entity_test {
    : title("Entity Test")
    : version("0.1.0")
}

const {
    physics.gravity: 9.81
    physics.growth_rate: 0.1
}

config {
    test.initial_mass: 100.0
    test.initial_energy: 50.0
    test.decay_rate: 0.01
    test.initial_counter: 100.0
}

strata simulation {
    : title("Simulation")
    : symbol("S")
    : stride(1)
}

era main {
    : initial
    : terminal
    : title("Main")
    : dt(1 <s>)

    strata {
        simulation: active
    }
}

# Define an entity with 5 particles and their nested signals
entity test.particle {
    : count(5)
    : stratum(simulation)
    
    # Scalar member: mass (increases over time based on growth rate)
    signal mass {
        : Scalar<kg, 0..1000>
        : title("Particle Mass")
        : symbol("m")

        initial { 100.0 <kg> }

        resolve {
            prev * 1.1
        }
    }

    # Scalar member: energy (decays over time)
    signal energy {
        : Scalar<kg*m^2/s^2, 0..1000>
        : title("Particle Energy")
        : symbol("E")

        initial { 50.0 <kg*m^2/s^2> }

        resolve {
            prev * 0.9
        }
    }
}

# Global signal: total mass of all particles (uses aggregate)
signal test.total_mass {
    : Scalar<kg, 0..5000>
    : strata(simulation)
    : title("Total Mass")
    : symbol("M_total")

    resolve {
        agg.sum(entity.test.particle, test.particle.mass)
    }
}

# Global signal: mean energy of all particles
signal test.mean_energy {
    : Scalar<kg*m^2/s^2, 0..1000>
    : strata(simulation)
    : title("Mean Energy")
    : symbol("E_mean")

    resolve {
        agg.mean(entity.test.particle, test.particle.energy)
    }
}

# Global signal: particle count
signal test.particle_count {
    : Scalar<1, 0..100>
    : strata(simulation)
    : title("Particle Count")
    : symbol("N")

    resolve {
        agg.count(entity.test.particle)
    }
}

# Simple counter signal to verify checkpoint state
signal test.counter {
    : Scalar<1, 0..10000>
    : strata(simulation)
    : title("Counter")
    : symbol("counter")

    initial { 100.0 }

    resolve {
        prev + 10.0
    }
}

# Field for observing total mass
field test.total_mass_field {
    : Scalar<kg>
    : strata(simulation)
    : topology(point_cloud)
    : title("Total Mass Field")

    measure {
        test.total_mass
    }
}
