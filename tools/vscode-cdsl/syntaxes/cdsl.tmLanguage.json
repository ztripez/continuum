{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "Continuum DSL",
  "scopeName": "source.cdsl",
  "patterns": [
    { "include": "#comments" },
    { "include": "#top-level-items" },
    { "include": "#expressions" }
  ],
  "repository": {
    "comments": {
      "patterns": [
        {
          "name": "comment.line.documentation.cdsl",
          "match": "///.*$"
        },
        {
          "name": "comment.line.module-documentation.cdsl",
          "match": "//!.*$"
        },
        {
          "name": "comment.line.double-slash.cdsl",
          "match": "//.*$"
        },
        {
          "name": "comment.line.hash.cdsl",
          "match": "#.*$"
        },
        {
          "name": "comment.block.cdsl",
          "begin": "/\\*",
          "end": "\\*/",
          "captures": {
            "0": { "name": "punctuation.definition.comment.cdsl" }
          }
        }
      ]
    },
    "top-level-items": {
      "patterns": [
        { "include": "#const-block" },
        { "include": "#config-block" },
        { "include": "#signal-def" },
        { "include": "#field-def" },
        { "include": "#operator-def" },
        { "include": "#fracture-def" },
        { "include": "#impulse-def" },
        { "include": "#chronicle-def" },
        { "include": "#entity-def" },
        { "include": "#strata-def" },
        { "include": "#era-def" },
        { "include": "#type-def" },
        { "include": "#fn-def" }
      ]
    },
    "const-block": {
      "begin": "\\b(const)\\s*\\{",
      "end": "\\}",
      "beginCaptures": {
        "1": { "name": "keyword.other.const.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#const-entry" }
      ]
    },
    "const-entry": {
      "match": "([a-zA-Z_][a-zA-Z0-9_]*(?:\\.[a-zA-Z_][a-zA-Z0-9_]*)*)\\s*(:)\\s*([^\\n#/]+)",
      "captures": {
        "1": { "name": "variable.other.constant.cdsl" },
        "2": { "name": "punctuation.separator.cdsl" },
        "3": { "patterns": [{ "include": "#literals" }] }
      }
    },
    "config-block": {
      "begin": "\\b(config)\\s*\\{",
      "end": "\\}",
      "beginCaptures": {
        "1": { "name": "keyword.other.config.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#config-entry" }
      ]
    },
    "config-entry": {
      "match": "([a-zA-Z_][a-zA-Z0-9_]*(?:\\.[a-zA-Z_][a-zA-Z0-9_]*)*)\\s*(:)\\s*([^\\n#/]+)",
      "captures": {
        "1": { "name": "variable.other.config.cdsl" },
        "2": { "name": "punctuation.separator.cdsl" },
        "3": { "patterns": [{ "include": "#literals" }] }
      }
    },
    "signal-def": {
      "begin": "\\b(signal)(\\.)",
      "end": "(?=\\bsignal\\b|\\bfield\\b|\\boperator\\b|\\bfracture\\b|\\bimpulse\\b|\\bchronicle\\b|\\bentity\\b|\\bstrata\\b|\\bera\\b|\\btype\\b|\\bfn\\b|\\bconst\\b|\\bconfig\\b|$(?!\\n))",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.signal.cdsl" },
        "2": { "name": "punctuation.accessor.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#definition-name" },
        { "include": "#definition-body" }
      ]
    },
    "field-def": {
      "begin": "\\b(field)(\\.)",
      "end": "(?=\\bsignal\\b|\\bfield\\b|\\boperator\\b|\\bfracture\\b|\\bimpulse\\b|\\bchronicle\\b|\\bentity\\b|\\bstrata\\b|\\bera\\b|\\btype\\b|\\bfn\\b|\\bconst\\b|\\bconfig\\b|$(?!\\n))",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.field.cdsl" },
        "2": { "name": "punctuation.accessor.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#definition-name" },
        { "include": "#definition-body" }
      ]
    },
    "operator-def": {
      "begin": "\\b(operator)(\\.)",
      "end": "(?=\\bsignal\\b|\\bfield\\b|\\boperator\\b|\\bfracture\\b|\\bimpulse\\b|\\bchronicle\\b|\\bentity\\b|\\bstrata\\b|\\bera\\b|\\btype\\b|\\bfn\\b|\\bconst\\b|\\bconfig\\b|$(?!\\n))",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.operator.cdsl" },
        "2": { "name": "punctuation.accessor.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#definition-name" },
        { "include": "#definition-body" }
      ]
    },
    "fracture-def": {
      "begin": "\\b(fracture)(\\.)",
      "end": "(?=\\bsignal\\b|\\bfield\\b|\\boperator\\b|\\bfracture\\b|\\bimpulse\\b|\\bchronicle\\b|\\bentity\\b|\\bstrata\\b|\\bera\\b|\\btype\\b|\\bfn\\b|\\bconst\\b|\\bconfig\\b|$(?!\\n))",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.fracture.cdsl" },
        "2": { "name": "punctuation.accessor.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#definition-name" },
        { "include": "#definition-body" }
      ]
    },
    "impulse-def": {
      "begin": "\\b(impulse)(\\.)",
      "end": "(?=\\bsignal\\b|\\bfield\\b|\\boperator\\b|\\bfracture\\b|\\bimpulse\\b|\\bchronicle\\b|\\bentity\\b|\\bstrata\\b|\\bera\\b|\\btype\\b|\\bfn\\b|\\bconst\\b|\\bconfig\\b|$(?!\\n))",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.impulse.cdsl" },
        "2": { "name": "punctuation.accessor.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#definition-name" },
        { "include": "#definition-body" }
      ]
    },
    "chronicle-def": {
      "begin": "\\b(chronicle)(\\.)",
      "end": "(?=\\bsignal\\b|\\bfield\\b|\\boperator\\b|\\bfracture\\b|\\bimpulse\\b|\\bchronicle\\b|\\bentity\\b|\\bstrata\\b|\\bera\\b|\\btype\\b|\\bfn\\b|\\bconst\\b|\\bconfig\\b|$(?!\\n))",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.chronicle.cdsl" },
        "2": { "name": "punctuation.accessor.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#definition-name" },
        { "include": "#definition-body" }
      ]
    },
    "entity-def": {
      "begin": "\\b(entity)(\\.)",
      "end": "(?=\\bsignal\\b|\\bfield\\b|\\boperator\\b|\\bfracture\\b|\\bimpulse\\b|\\bchronicle\\b|\\bentity\\b|\\bstrata\\b|\\bera\\b|\\btype\\b|\\bfn\\b|\\bconst\\b|\\bconfig\\b|$(?!\\n))",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.entity.cdsl" },
        "2": { "name": "punctuation.accessor.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#definition-name" },
        { "include": "#definition-body" }
      ]
    },
    "strata-def": {
      "begin": "\\b(strata)(\\.)",
      "end": "(?=\\bsignal\\b|\\bfield\\b|\\boperator\\b|\\bfracture\\b|\\bimpulse\\b|\\bchronicle\\b|\\bentity\\b|\\bstrata\\b|\\bera\\b|\\btype\\b|\\bfn\\b|\\bconst\\b|\\bconfig\\b|$(?!\\n))",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.strata.cdsl" },
        "2": { "name": "punctuation.accessor.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#definition-name" },
        { "include": "#definition-body" }
      ]
    },
    "era-def": {
      "begin": "\\b(era)(\\.)",
      "end": "(?=\\bsignal\\b|\\bfield\\b|\\boperator\\b|\\bfracture\\b|\\bimpulse\\b|\\bchronicle\\b|\\bentity\\b|\\bstrata\\b|\\bera\\b|\\btype\\b|\\bfn\\b|\\bconst\\b|\\bconfig\\b|$(?!\\n))",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.era.cdsl" },
        "2": { "name": "punctuation.accessor.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#definition-name" },
        { "include": "#definition-body" }
      ]
    },
    "type-def": {
      "begin": "\\b(type)(\\.)",
      "end": "(?=\\bsignal\\b|\\bfield\\b|\\boperator\\b|\\bfracture\\b|\\bimpulse\\b|\\bchronicle\\b|\\bentity\\b|\\bstrata\\b|\\bera\\b|\\btype\\b|\\bfn\\b|\\bconst\\b|\\bconfig\\b|$(?!\\n))",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.type.cdsl" },
        "2": { "name": "punctuation.accessor.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#definition-name" },
        { "include": "#definition-body" }
      ]
    },
    "fn-def": {
      "begin": "\\b(fn)(\\.)",
      "end": "(?=\\bsignal\\b|\\bfield\\b|\\boperator\\b|\\bfracture\\b|\\bimpulse\\b|\\bchronicle\\b|\\bentity\\b|\\bstrata\\b|\\bera\\b|\\btype\\b|\\bfn\\b|\\bconst\\b|\\bconfig\\b|$(?!\\n))",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.function.cdsl" },
        "2": { "name": "punctuation.accessor.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#fn-name-and-params" },
        { "include": "#definition-body" }
      ]
    },
    "fn-name-and-params": {
      "begin": "([a-zA-Z_][a-zA-Z0-9_]*(?:\\.[a-zA-Z_][a-zA-Z0-9_]*)*)\\s*(\\()",
      "end": "(\\))",
      "beginCaptures": {
        "1": { "name": "entity.name.function.cdsl" },
        "2": { "name": "punctuation.parenthesis.open.cdsl" }
      },
      "endCaptures": {
        "1": { "name": "punctuation.parenthesis.close.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        {
          "match": "([a-zA-Z_][a-zA-Z0-9_]*)",
          "name": "variable.parameter.cdsl"
        },
        {
          "match": ",",
          "name": "punctuation.separator.cdsl"
        }
      ]
    },
    "definition-name": {
      "match": "([a-zA-Z_][a-zA-Z0-9_]*(?:\\.[a-zA-Z_][a-zA-Z0-9_]*)*)",
      "captures": {
        "1": { "name": "entity.name.cdsl" }
      }
    },
    "definition-body": {
      "begin": "\\{",
      "end": "\\}",
      "beginCaptures": {
        "0": { "name": "punctuation.brace.open.cdsl" }
      },
      "endCaptures": {
        "0": { "name": "punctuation.brace.close.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#block-keywords" },
        { "include": "#attributes" },
        { "include": "#inner-blocks" },
        { "include": "#expressions" }
      ]
    },
    "block-keywords": {
      "match": "\\b(resolve|measure|when|emit|assert|collect|on|config|initial|terminal)\\b",
      "name": "keyword.control.block.cdsl"
    },
    "attributes": {
      "patterns": [
        {
          "match": "(:)\\s*(Scalar|Vector|Tensor|Map)\\b",
          "captures": {
            "1": { "name": "punctuation.separator.cdsl" },
            "2": { "name": "support.type.cdsl" }
          }
        },
        {
          "match": "(:)\\s*(strata|topology|title|symbol|uses|phase|era)\\s*(\\()",
          "captures": {
            "1": { "name": "punctuation.separator.cdsl" },
            "2": { "name": "keyword.attribute.cdsl" },
            "3": { "name": "punctuation.parenthesis.open.cdsl" }
          }
        },
        {
          "match": "(:)\\s*(initial|terminal)\\b",
          "captures": {
            "1": { "name": "punctuation.separator.cdsl" },
            "2": { "name": "keyword.attribute.cdsl" }
          }
        }
      ]
    },
    "inner-blocks": {
      "begin": "\\b(resolve|measure|when|emit|assert|collect|config)\\s*\\{",
      "end": "\\}",
      "beginCaptures": {
        "1": { "name": "keyword.control.block.cdsl" }
      },
      "patterns": [
        { "include": "#comments" },
        { "include": "#expressions" },
        { "include": "#inner-blocks" }
      ]
    },
    "expressions": {
      "patterns": [
        { "include": "#comments" },
        { "include": "#keywords" },
        { "include": "#operators" },
        { "include": "#references" },
        { "include": "#function-calls" },
        { "include": "#literals" },
        { "include": "#identifiers" }
      ]
    },
    "keywords": {
      "patterns": [
        {
          "match": "\\b(if|else|let|in)\\b",
          "name": "keyword.control.cdsl"
        },
        {
          "match": "\\b(prev|dt_raw|collected|payload)\\b",
          "name": "variable.language.cdsl"
        },
        {
          "match": "\\b(self)\\b",
          "name": "variable.language.self.cdsl"
        },
        {
          "match": "\\b(and|or|not)\\b",
          "name": "keyword.operator.logical.cdsl"
        },
        {
          "match": "\\b(sum|count|product|min|max|mean|any|all|none)\\b",
          "name": "keyword.operator.aggregate.cdsl"
        },
        {
          "match": "\\b(other|pairs|filter|first|nearest|within)\\b",
          "name": "keyword.operator.entity.cdsl"
        },
        {
          "match": "\\b(PI|TAU|PHI|E|I)\\b|[πτφℯⅈ]",
          "name": "constant.language.math.cdsl"
        },
        {
          "match": "\\b(warn|error|halt|fatal)\\b",
          "name": "keyword.other.severity.cdsl"
        }
      ]
    },
    "operators": {
      "patterns": [
        {
          "match": "<-",
          "name": "keyword.operator.assignment.cdsl"
        },
        {
          "match": "==|!=|<=|>=|<|>",
          "name": "keyword.operator.comparison.cdsl"
        },
        {
          "match": "&&|\\|\\|",
          "name": "keyword.operator.logical.cdsl"
        },
        {
          "match": "\\+|-|\\*|/|%|\\^",
          "name": "keyword.operator.arithmetic.cdsl"
        },
        {
          "match": "!",
          "name": "keyword.operator.logical.not.cdsl"
        },
        {
          "match": "\\.\\.",
          "name": "keyword.operator.range.cdsl"
        }
      ]
    },
    "references": {
      "patterns": [
        {
          "match": "\\b(signal)(\\.)",
          "captures": {
            "1": { "name": "keyword.other.reference.signal.cdsl" },
            "2": { "name": "punctuation.accessor.cdsl" }
          }
        },
        {
          "match": "\\b(const)(\\.)",
          "captures": {
            "1": { "name": "keyword.other.reference.const.cdsl" },
            "2": { "name": "punctuation.accessor.cdsl" }
          }
        },
        {
          "match": "\\b(config)(\\.)",
          "captures": {
            "1": { "name": "keyword.other.reference.config.cdsl" },
            "2": { "name": "punctuation.accessor.cdsl" }
          }
        },
        {
          "match": "\\b(field)(\\.)",
          "captures": {
            "1": { "name": "keyword.other.reference.field.cdsl" },
            "2": { "name": "punctuation.accessor.cdsl" }
          }
        },
        {
          "match": "\\b(entity)(\\.)",
          "captures": {
            "1": { "name": "keyword.other.reference.entity.cdsl" },
            "2": { "name": "punctuation.accessor.cdsl" }
          }
        }
      ]
    },
    "function-calls": {
      "patterns": [
        {
          "match": "\\b([a-zA-Z_][a-zA-Z0-9_]*(?:\\.[a-zA-Z_][a-zA-Z0-9_]*)*)\\s*(?=\\()",
          "captures": {
            "1": { "name": "entity.name.function.call.cdsl" }
          }
        }
      ]
    },
    "literals": {
      "patterns": [
        {
          "name": "string.quoted.double.cdsl",
          "begin": "\"",
          "end": "\"",
          "patterns": [
            {
              "name": "constant.character.escape.cdsl",
              "match": "\\\\."
            }
          ]
        },
        {
          "match": "-?\\d+\\.\\d+([eE][+-]?\\d+)?",
          "name": "constant.numeric.float.cdsl"
        },
        {
          "match": "-?\\d+[eE][+-]?\\d+",
          "name": "constant.numeric.float.scientific.cdsl"
        },
        {
          "match": "-?\\d+",
          "name": "constant.numeric.integer.cdsl"
        },
        {
          "comment": "Unit annotation like <K>, <W/m²>, <kg/s> - no spaces allowed inside",
          "match": "<[a-zA-Z0-9/·°⁰¹²³⁴⁵⁶⁷⁸⁹⁻⁺_-]+>",
          "name": "support.type.unit.cdsl"
        }
      ]
    },
    "identifiers": {
      "match": "\\b[a-zA-Z_][a-zA-Z0-9_]*\\b",
      "name": "variable.other.cdsl"
    }
  }
}
